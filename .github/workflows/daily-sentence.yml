name: Daily Inspiration Update

on:
  schedule:
    - cron: '0 0 * * *' # 每天UTC时间00:00运行（北京时间8:00）
  workflow_dispatch:    # 允许手动触发

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Get daily sentence
      id: get-sentence
      run: |
        # 下载并运行Python脚本获取数据
        curl -o get_daily_sentence.py https://gist.githubusercontent.com/raw/... # 替换为实际脚本URL
        
        python get_daily_sentence.py
        
        # 从文件中读取数据
        CONTENT=$(cat content.txt)
        NOTE=$(cat note.txt)
        TRANSLATION=$(cat translation.txt)
        PIC_URL=$(cat picture_url.txt)
        DATE=$(cat date.txt)
        
        # 设置环境变量
        echo "CONTENT=$CONTENT" >> $GITHUB_ENV
        echo "NOTE=$NOTE" >> $GITHUB_ENV
        echo "TRANSLATION=$TRANSLATION" >> $GITHUB_ENV
        echo "PIC_URL=$PIC_URL" >> $GITHUB_ENV
        echo "DATE=$DATE" >> $GITHUB_ENV
        
    - name: Update README
      run: |
        # 创建Python脚本来安全更新README
        cat > update_readme.py <<EOL
import re
import os

def read_file(filename):
    try:
        with open(filename, 'r') as f:
            return f.read()
    except:
        return ""

def write_file(filename, content):
    with open(filename, 'w') as f:
        f.write(content)

# 获取环境变量
content = os.environ.get('CONTENT', '')
note = os.environ.get('NOTE', '')
translation = os.environ.get('TRANSLATION', '')
pic_url = os.environ.get('PIC_URL', '')
date = os.environ.get('DATE', '')

# 读取原始README内容
readme_content = read_file('README.md')

# 定义替换模板
template = r'''
<div align="center" class="inspiration-card">
  <table>
    <tr>
      <td width="60%">
        <h3>📜 每日一语</h3>
        <img src="https://img.shields.io/badge/词霸每日一句-DATE-blueviolet?style=flat-square" alt="日期标记">
        <p><b>英文：</b>CONTENT</p>
        <p><b>释义：</b>NOTE</p>
        <p><i>TRANSLATION</i></p>
      </td>
      <td width="40%">
        <img src="PIC_URL" width="300" alt="每日配图">
      </td>
    </tr>
  </table>
</div>
'''

# 替换变量
template = template.replace('CONTENT', content)
template = template.replace('NOTE', note)
template = template.replace('TRANSLATION', translation)
template = template.replace('PIC_URL', pic_url)
template = template.replace('DATE', date)

# 查找替换区域
pattern = r'(<!-- BEGIN DAILY SENTENCE -->).*?(<!-- END DAILY SENTENCE -->)'
replacement = r'\1\n' + template + '\n\2'

# 执行替换
updated_content = re.sub(pattern, replacement, readme_content, flags=re.DOTALL)

# 写入更新后的内容
write_file('README.md', updated_content)
EOL

        # 运行脚本
        python update_readme.py
        
    - name: Commit changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git commit -m "📅 自动更新每日金句 (${{ env.DATE }})"
        git push
